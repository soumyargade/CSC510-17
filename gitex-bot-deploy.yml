---
- name: bot setup
  hosts: localhost
  become: yes
  tasks:
  - name: install nodejs & npm
    yum:
      name: npm
      state: present
  - name: install forever
    npm:
      name: forever
      global: yes
      state: present
  - name: clone repo
    git:
      repo: https://{{ lookup("env", "GITHUB_TOKEN") }}@github.ncsu.edu/csc510-s2022/CSC510-17.git
      dest: /home/srgade/gitex
      clone: yes
      update: yes
  - name: install node modules
    npm:
      path: /home/srgade/gitex
  - name: check list of running apps
    become: true
    become_method: sudo
    become_user: "{{ lookup('env', 'USER') }}"
    command: forever list
    register: forever_list
    changed_when: false
  - name: start app
    become: true
    become_method: sudo
    become_user: "{{ lookup('env', 'USER') }}"
    command: forever start /home/srgade/gitex/index.js
    when: "forever_list.stdout.find('/home/srgade/gitex/index.js') == -1"